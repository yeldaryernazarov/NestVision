import { Telegraf } from 'telegraf';
import dotenv from 'dotenv';

// ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะธะท .env ัะฐะนะปะฐ
dotenv.config();

// ะขะพะบะตะฝ ะฑะพัะฐ (ะธะท ะฟะตัะตะผะตะฝะฝะพะน ะพะบััะถะตะฝะธั ะธะปะธ ะฝะฐะฟััะผัั)
const BOT_TOKEN = process.env.BOT_TOKEN || '8504010525:AAGy12ITz9T2P5BhPYtjt99vf2EWmOjy9NA';

// ID ะบะฐะฝะฐะปะฐ (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั ัะธะปัััะฐัะธะธ)
const CHANNEL_ID = process.env.CHANNEL_ID || '-1003264139245';

// ID ะฑะพัะฐ (ะบัะดะฐ ะฟะตัะตััะปะฐัั - ััะพ ัะฐะผ ะฑะพั, ะฟะตัะตััะปะฐะตะผ ะฒ ะปะธัะบั)
// ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ัะฒะพะน user ID, ะตัะปะธ ัะพัะตัั ะฟะพะปััะฐัั ัะฒะตะดะพะผะปะตะฝะธั
const TARGET_CHAT_ID = process.env.TARGET_CHAT_ID || null; // null = ะฟะตัะตััะปะฐัั ัะฐะผะพะผั ะฑะพัั

const bot = new Telegraf(BOT_TOKEN);

console.log('๐ค Telegram Channel Forwarder ะทะฐะฟััะตะฝ...');
console.log(`๐ก ะกะปััะฐั ะบะฐะฝะฐะป: ${CHANNEL_ID}`);
console.log(`๐ค ะะตัะตััะปะฐั ะฒ: ${TARGET_CHAT_ID || 'ัะฐะผะพะณะพ ะฑะพัะฐ (ะปะธัะบะฐ)'}`);

// ะะฑัะฐะฑะพััะธะบ ะดะปั ัะพะพะฑัะตะฝะธะน ะธะท ะบะฐะฝะฐะปะฐ (channel_post)
bot.on('channel_post', async (ctx) => {
    try {
        const post = ctx.channelPost;
        const chatId = ctx.chat?.id;
        
        // ะัะพะฒะตััะตะผ, ััะพ ัะพะพะฑัะตะฝะธะต ะธะท ะฝัะถะฝะพะณะพ ะบะฐะฝะฐะปะฐ (ะตัะปะธ ัะบะฐะทะฐะฝ)
        if (CHANNEL_ID && chatId && chatId.toString() !== CHANNEL_ID.replace('-', '')) {
            console.log(`โญ๏ธ  ะัะพะฟััะบะฐะตะผ ัะพะพะฑัะตะฝะธะต ะธะท ะดััะณะพะณะพ ะบะฐะฝะฐะปะฐ: ${chatId}`);
            return;
        }
        
        console.log('\n๐จ ะะพะปััะตะฝะพ ะฝะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะธะท ะบะฐะฝะฐะปะฐ:');
        console.log(`   ะะฐะฝะฐะป ID: ${chatId}`);
        console.log(`   Message ID: ${post.message_id}`);
        console.log(`   ะขะธะฟ: ${post.video ? 'ะะธะดะตะพ' : post.photo ? 'ะคะพัะพ' : post.document ? 'ะะพะบัะผะตะฝั' : 'ะขะตะบัั'}`);
        
        if (post.video) {
            console.log(`   ะะธะดะตะพ: ${post.video.file_name || 'ะฑะตะท ะธะผะตะฝะธ'}, ัะฐะทะผะตั: ${(post.video.file_size / 1024 / 1024).toFixed(2)} MB`);
        }
        
        if (post.caption) {
            console.log(`   ะะพะดะฟะธัั: ${post.caption.substring(0, 50)}...`);
        }
        
        // ะะตัะตััะปะฐะตะผ ัะพะพะฑัะตะฝะธะต ะฑะพัั ะฒ ะปะธัะบั
        // ะัะปะธ TARGET_CHAT_ID ะฝะต ัะบะฐะทะฐะฝ, ะฟะตัะตััะปะฐะตะผ ัะฐะผะพะผั ะฑะพัั (ะฝะพ ััะพ ะฝะต ััะฐะฑะพัะฐะตั)
        // ะะพััะพะผั ะปัััะต ะฟะตัะตััะปะฐัั ะฒ ะบะฐะฝะฐะป ะธะปะธ ะธัะฟะพะปัะทะพะฒะฐัั forward
        
        // ะะฐัะธะฐะฝั 1: ะะตัะตััะปะฐะตะผ ัะพะพะฑัะตะฝะธะต (forward) - ัะพััะฐะฝัะตั ะพัะธะณะธะฝะฐะปัะฝัั ะธะฝัะพัะผะฐัะธั
        if (TARGET_CHAT_ID) {
            try {
                await ctx.telegram.forwardMessage(
                    TARGET_CHAT_ID,
                    chatId,
                    post.message_id
                );
                console.log('โ ะกะพะพะฑัะตะฝะธะต ะฟะตัะตัะปะฐะฝะพ ะฒ ัะบะฐะทะฐะฝะฝัะน ัะฐั');
            } catch (error) {
                console.error('โ ะัะธะฑะบะฐ ะฟัะธ ะฟะตัะตััะปะบะต:', error.message);
            }
        } else {
            // ะะฐัะธะฐะฝั 2: ะะพะฟะธััะตะผ ัะพะพะฑัะตะฝะธะต ะฑะพัั (ะตัะปะธ ะฑะพั ะผะพะถะตั ะฟะธัะฐัั ัะฐะผะพะผั ัะตะฑะต)
            // ะะพ ะฑะพัั ะฝะต ะผะพะณัั ะฟะธัะฐัั ัะฐะผะธะผ ัะตะฑะต, ะฟะพััะพะผั ะฝัะถะฝะพ ัะบะฐะทะฐัั TARGET_CHAT_ID
            console.log('โ๏ธ  TARGET_CHAT_ID ะฝะต ัะบะฐะทะฐะฝ. ะฃะบะฐะถะธัะต ัะฒะพะน user ID ะดะปั ะฟะพะปััะตะฝะธั ัะพะพะฑัะตะฝะธะน.');
            console.log('   ะะปะธ ะธัะฟะพะปัะทัะนัะต ะดััะณะพะน ะผะตัะพะด ะฟะตัะตััะปะบะธ.');
        }
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะฟัะธ ะพะฑัะฐะฑะพัะบะต ัะพะพะฑัะตะฝะธั:', error);
    }
});

// ะะฑัะฐะฑะพััะธะบ ะดะปั ะพะฑััะฝัั ัะพะพะฑัะตะฝะธะน (ะฝะฐ ัะปััะฐะน, ะตัะปะธ ััะพ-ัะพ ะฟัะธะดะตั ะฒ ะปะธัะบั)
bot.on('message', async (ctx) => {
    // ะะณะฝะพัะธััะตะผ, ัะฐะบ ะบะฐะบ ะฝะฐั ะธะฝัะตัะตัััั ัะพะปัะบะพ channel_post
    // ะะพ ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ะดะปั ะพัะปะฐะดะบะธ
    if (ctx.message.chat.type === 'private') {
        console.log('๐ฌ ะะพะปััะตะฝะพ ะปะธัะฝะพะต ัะพะพะฑัะตะฝะธะต (ะธะณะฝะพัะธััะตะผ)');
    }
});

// ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
bot.catch((err, ctx) => {
    console.error('โ ะัะธะฑะบะฐ ะฑะพัะฐ:', err);
});

// ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ
bot.launch()
    .then(() => {
        console.log('\nโ ะะพั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ ะธ ัะปััะฐะตั ะบะฐะฝะฐะป!');
        console.log('๐ ะะปั ะพััะฐะฝะพะฒะบะธ ะฝะฐะถะผะธัะต Ctrl+C\n');
    })
    .catch((error) => {
        console.error('โ ะัะธะฑะบะฐ ะฟัะธ ะทะฐะฟััะบะต ะฑะพัะฐ:', error);
        process.exit(1);
    });

// Graceful shutdown
process.once('SIGINT', () => {
    console.log('\n๐ ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ...');
    bot.stop('SIGINT');
    process.exit(0);
});

process.once('SIGTERM', () => {
    console.log('\n๐ ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ...');
    bot.stop('SIGTERM');
    process.exit(0);
});

